name: run

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '10 2 * * *'  # 注意：cron要用引号包裹

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          
      - name: Install dependencies
        run: |
          # 如果没有 package.json，创建一个简单的
          if [ ! -f package.json ]; then
            echo '{"name":"glados-checkin","version":"1.0.0"}' > package.json
          fi
          npm install  # 使用 install 而不是 ci
          
      - name: Create and run checkin script
        run: |
          # 直接创建并运行脚本
          cat > checkin.js << 'EOF'
          console.log('=== 开始执行 GLaDOS 签到 ===');
          console.log('当前时间:', new Date().toISOString());
          
          // 检查环境变量
          console.log('GLADOS 变量:', process.env.GLADOS ? '已设置' : '未设置');
          console.log('NOTIFY 变量:', process.env.NOTIFY ? '已设置' : '未设置');
          
          // 这里继续粘贴您的完整代码
          const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));
          
          const glados = async () => {
            // ... 您的代码 ...
          };
          
          const notify = async (contents) => {
            // ... 您的代码 ...
          };
          
          const main = async () => {
            console.log('执行签到...');
            const result = await glados();
            console.log('签到结果:', result);
            console.log('发送通知...');
            await notify(result);
            console.log('完成!');
          };
          
          main().catch(console.error);
          EOF
          
          node checkin.js
        env:
          GLADOS: ${{ secrets.GLADOS }}
          NOTIFY: ${{ secrets.NOTIFY }}
